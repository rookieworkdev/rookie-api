name: Job Scraper Cron

on:
  schedule:
    # Run Indeed scraper daily at 6 AM UTC (7 AM CET / 8 AM CEST)
    - cron: '0 6 * * *'
    # Run cleanup weekly on Sundays at midnight UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to run'
        required: true
        default: 'indeed'
        type: choice
        options:
          - indeed
          - cleanup

jobs:
  run-scraper:
    runs-on: ubuntu-latest
    # Only run Indeed scraper on daily schedule or manual trigger
    if: github.event.schedule != '0 0 * * 0' || github.event.inputs.action == 'indeed'

    steps:
      - name: Run Indeed Scraper
        if: github.event.inputs.action != 'cleanup'
        run: |
          echo "Starting Indeed job scraper..."

          response=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ secrets.API_BASE_URL }}/api/scraping/jobs/indeed" \
            -H "Content-Type: application/json" \
            -H "X-API-Key: ${{ secrets.SCRAPER_API_KEY }}" \
            -d '{"country": "SE", "maxItems": 50}')

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "Response: $body"
          echo "HTTP Status: $http_code"

          if [ "$http_code" -ne 200 ]; then
            echo "Scraper failed with status $http_code"
            exit 1
          fi

          echo "Indeed scraper completed successfully"

  run-cleanup:
    runs-on: ubuntu-latest
    # Only run cleanup on weekly schedule or manual trigger
    if: github.event.schedule == '0 0 * * 0' || github.event.inputs.action == 'cleanup'

    steps:
      - name: Run Job Cleanup
        run: |
          echo "Starting job cleanup..."

          response=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ secrets.API_BASE_URL }}/api/scraping/jobs/cleanup" \
            -H "Content-Type: application/json" \
            -H "X-API-Key: ${{ secrets.SCRAPER_API_KEY }}")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "Response: $body"
          echo "HTTP Status: $http_code"

          if [ "$http_code" -ne 200 ]; then
            echo "Cleanup failed with status $http_code"
            exit 1
          fi

          echo "Cleanup completed successfully"
